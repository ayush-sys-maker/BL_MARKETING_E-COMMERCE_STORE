<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout | BL TRADING</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://api.fontshare.com/v2/css?f[]=satoshi@301&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: 'Satoshi', sans-serif;
            background-color: #f8f9fa;
        }
        .ranade-bold {
            font-weight: 700;
            font-size: 2rem;
        }
        .price {
            color: #6c757d;
            font-size: 0.9rem;
        }
        .back:hover {
            text-decoration: none;
        }
        .form-control:focus {
            border-color: #000;
            box-shadow: 0 0 0 0.25rem rgba(0, 0, 0, 0.1);
        }
        .scroll-container {
            scrollbar-width: none; /* Firefox */
        }
        .scroll-container::-webkit-scrollbar {
            display: none; /* Chrome/Safari/Webkit */
        }
        .checkout-section {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        @media (max-width: 991.98px) {
  .row.gx-5 {
    --bs-gutter-x: 1rem;
  }
  .col-lg-7, .col-lg-5 {
    flex: 0 0 100%;
    max-width: 100%;
  }
  .checkout-section {
    margin-bottom: 1.5rem;
  }
  .navbar .container, .container {
    padding-left: 0.75rem;
    padding-right: 0.75rem;
  }
  .card.mb-3.border-0 {
    flex-direction: column;
    align-items: center;
    text-align: center;
  }
  .card.mb-3.border-0 .col-md-4,
  .card.mb-3.border-0 .col-md-8 {
    max-width: 100%;
    flex: 0 0 100%;
  }
  .card.mb-3.border-0 img {
    margin-bottom: 1rem;
    width: 100%;
    height: auto;
  }
  .navbar-nav {
    gap: 1rem !important;
    padding-left: 0 !important;
    margin-left: 0 !important;
  }
  .navbar .input-group {
    width: 100%;
  }
  .navbar .d-flex.gap-2 {
    margin-left: 0 !important;
  }
}
    </style>
</head>
<body>
  
    
<!--NAVBAR--> 
<header class="sticky-top bg-white shadow-sm">
  <nav class="navbar navbar-expand-lg container py-3 navbar-light bg-white">
    <div class="container-fluid">
      <!-- Logo/Brand -->
      <a class="navbar-brand fw-bold" href="#">   BL MARKETING</a>
      
      <!-- Mobile Toggle -->
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      
      <!-- Main Content -->
      <div class="collapse navbar-collapse" id="navbarContent">
        <!-- Menu -->
        <ul class="navbar-nav gap-lg-4 gap-2 ms-lg-5 ps-lg-5 mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link" href="/home">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="/sportswear">Sportswear</a></li>
          <li class="nav-item"><a class="nav-link" href="/WOMEN">Women</a></li>
          <li class="nav-item"><a class="nav-link" href="/SOCKS">Socks </a></li>
        </ul>
        
        <!-- Search -->
        <form class="d-flex ms-lg-5 me-lg-0 mx-auto my-2 my-lg-0" role="search"  action="/search" method="get"  >
          <div class="input-group   ">
            <input class="form-control" type="search" placeholder="Search" name="q">
            <button class="btn btn-outline-secondary" type="submit">
              <i class="fas fa-search"></i>
            </button>
          </div>
        </form>
        
        <!-- Actions -->
        <div class="d-flex gap-2 align-items-center ms-lg-5">
        
        
       


<!-- Cart button -->


 <% if(!user){ %>
  <!-- Login button -->
  <button type="button" class="btn" data-bs-toggle="modal" data-bs-target="#signInModal">
    Sign In
  </button>
  <button type="button" class="btn" data-bs-toggle="modal" data-bs-target="#loginModal">
   Login
  </button>
  <% }else{ %>
    <button  class="btn btn-primary  rounded-pill" onclick="window.location.href='/order/my-orders'" style="font-size: small;"  >MY ORDER</button>

  <form action="/auth/logout" method="post">
  <button type="submit" class="btn fs-6 " >
   <i class="fas fa-sign-out-alt"></i>
  </button>

  </form>
  <% } %>
  <button class="btn position-relative p-1">
    <a href="/cart"><i class="fas fa-shopping-cart fs-5"></i></a>
   </button>

        </div>
      </div>
    </div>
  </nav>
</header>

<!-- CHECKOUT HEADER -->
<div class="container mt-4 text-center">
  <h2 class="ranade-bold">CHECKOUT</h2>
  <p class="price mt-1">[ <%= cartItems.length %> Item Added ]</p>
</div>

<!-- MAIN CHECKOUT CONTENT -->
<div class="container mt-4">
  <div class="row gx-5">

    <!-- LEFT: CUSTOMER + PRODUCTS -->
    <div class="col-lg-7 scroll-container" style="max-height: 650px; overflow-y: auto;">

      <!-- Customer Info -->
      <div class="checkout-section p-4 mb-4">
        <h4 class="fw-bold mb-4">CUSTOMER INFORMATION</h4>

        <% if (address.length === 0) { %>
          <!-- Address Form -->
          <form id="checkoutForm" action="/payment/checkout/address" method="post">
            <div class="mb-3">
              <label class="form-label">Email Address</label>
              <input type="email" name="email" class="form-control" placeholder="your@email.com">
            </div>
            <div class="row">
              <div class="col-md-6 mb-3"><input type="text" name="firstName" class="form-control" placeholder="First Name"></div>
              <div class="col-md-6 mb-3"><input type="text" name="lastName" class="form-control" placeholder="Last Name"></div>
            </div>
            <div class="mb-3"><input type="text" name="user_address" class="form-control" placeholder="Street Address"></div>
            <div class="row">
              <div class="col-md-4 mb-3"><input type="text" name="city" class="form-control" placeholder="City"></div>
              <div class="col-md-4 mb-3"><input type="text" name="state" class="form-control" placeholder="State"></div>
              <div class="col-md-4 mb-3"><input type="text" name="zip" class="form-control" placeholder="ZIP Code"></div>
            </div>
            <div class="mb-3"><input type="tel" name="phone_number" class="form-control" placeholder="Phone Number"></div>
            <div class="text-center"><button type="submit" class="btn btn-dark w-25 fw-bold">Save Address</button></div>
          </form>
        <% } else { %>
          <!-- Saved Address -->
          <p>Address: <%= address[0].street_address %></p>
          <p>City: <%= address[0].city %></p>
          <p>State: <%= address[0].state %></p>
          <p>ZIP: <%= address[0].code %></p>
          <p>Phone: <%= address[0].phone_number %></p>
          <form action="/payment/removeaddress/<%= address[0].id %>" method="POST">
            <div class="text-end"><button type="submit" class="btn btn-dark">Delete</button></div>
          </form>
        <% } %>
      </div>

      <!-- Cart Items -->
      <% cartItems.forEach(function(product) { %>
        <div class="checkout-section mb-4 p-4">
          <div class="card border-0">
            <div class="row g-0">
              <!-- Image -->
              <div class="col-md-4">
                <img src="<%= product.desktop_image_url %>" class="d-block w-100" alt="Product">
              </div>
              <!-- Details -->
              <div class="col-md-8">
                <div class="card-body">
                  <h5 class="card-title"><%= product.name %></h5>
                  <p class="mt-2 text-muted">₹<%= product.price %></p>
                  <p><strong>COLOR:</strong> <%= product.color %></p>
                  <p><strong>SIZE:</strong> <%= product.size %></p>
                </div>
              </div>
            </div>
            <div class="text-end">
              <form action="/payment/remove/<%= product.id %>" method="POST">
                <button type="submit" class="btn btn-dark">Delete</button>
              </form>
            </div>
          </div>
        </div>
      <% }); %>
    </div>

    <!-- RIGHT: ORDER SUMMARY -->
    <div class="col-lg-5">
      <div class="checkout-section p-4">
        <h4 class="fw-bold mb-4">ORDER SUMMARY</h4>
        <form action="/order/addorder" method="POST">
          <div class="d-flex justify-content-between mb-2"><span>Subtotal:</span><span>₹<%= total %></span></div>
          <div class="d-flex justify-content-between mb-2"><span>Shipping:</span><span><%= total > 499 ? "₹0.00" : "₹69.00" %></span></div>
          <hr>
          <div class="d-flex justify-content-between fw-bold mb-3"><span>TOTAL:</span><span>₹<%= total + (total > 499 ? 0 : 69) %></span></div>
          <div class="d-flex justify-content-between mb-4 fw-bold mt-3 ">
            <input class="form-check-input" type="radio" name="payment_method" value="cod" checked> Cash On Delivery
            <input class="form-check-input" type="radio" name="payment_method" value="online"> Pay Online
          </div>
          
          <button type="button" class="btn btn-dark w-100 fw-bold py-2">PAY NOW</button>
          
          <div class="mt-3 text-center"><a href="/home" class="text-decoration-none price">← Back to Home</a></div>
        </form>
      </div>
    </div>
  </div>
</div>
 
<section class="footer bg-light">
  <div class="container">
    <footer class="row row-cols-1 row-cols-sm-2 row-cols-md-5 py-5 border-top">

      <!-- Logo -->
      <div class="col text-center text-md-start footerlogo">
        <a href="/" class="d-inline-block">
          <img src="/Bl_logo.png" alt="Bl_logo" style="max-height: 150px;">
        </a>
        <p class="text-muted small mb-0"> 2025 BL MARKETING</p>
      </div>

      <!-- More -->
      <div class="col mb-3">
        <h5>MORE</h5>
        <ul class="nav flex-column">
          <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-body-secondary">Catalog</a></li>
          <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-body-secondary">Contact</a></li>
          <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-body-secondary">Owner</a></li>
          <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-body-secondary">About us</a></li>
        </ul>
      </div>

      <!-- Inventory -->
      <div class="col mb-3">
        <h5>INVENTORY</h5>
        <ul class="nav flex-column">
          <li class="nav-item mb-2"><a href="/sportswear" class="nav-link p-0 text-body-secondary">Track</a></li>
          <li class="nav-item mb-2"><a href="/sportswear" class="nav-link p-0 text-body-secondary">Shorts</a></li>
          <li class="nav-item mb-2"><a href="/WOMEN" class="nav-link p-0 text-body-secondary">Bra</a></li>
          <li class="nav-item mb-2"><a href="/SOCKS" class="nav-link p-0 text-body-secondary">Socks</a></li>
        </ul>
      </div>

      <!-- Social Media -->
      <div class="col mb-3 text-center text-md-start">
        <h5>FOLLOW US</h5>
        <div class="d-flex justify-content-center justify-content-md-start gap-3 mt-2">
          <a href="https://www.instagram.com/_blmarketing_?igsh=eTllc3hhenBkdHI0" target="_blank" class="text-dark fs-4">
            <i class="fa-brands fa-instagram"></i>
          </a>
          <a href="https://wa.me/9746557300" target="_blank" class="text-dark fs-4">
            <i class="fa-brands fa-whatsapp"></i>
          </a>
        </div>
      </div>

    </footer>
  </div>
</section>
    
<!-- Sign In Modal -->
<div class="modal fade" id="signInModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="mb-3">
        <label class="form-label">Name</label>
        <input type="text" name="name" class="form-control w-100 " required autocomplete="off" >
      </div>
      <div class="modal-header">
        <h5 class="modal-title">Sign In</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form  action="/auth/signup" method="post"   >
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" name="username" class="form-control w-100 " required autocomplete="off" >
          </div>
          <div class="mb-3">
            <label class="form-label">Password</label>
            <input type="password" name="password" class="form-control  w-100 " required  autocomplete="new-password" >
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary">Sign In</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="loginModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Login</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form action="/auth/login" method="post"   >
          <div class="mb-3  ">
            <label class="form-label">Username</label>
            <input type="text" name="username" class="form-control w-100 " required  autocomplete="off" >
          </div>
          <div class="mb-3">
            <label class="form-label">Password</label>
            <input type="password" name="password" class="form-control  w-100 " required  autocomplete="new-password"  >
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary">Login</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>


     <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" crossorigin="anonymous"></script>
    
        <!-- ... your full checkout page ... -->

    <!-- Razorpay & Axios -->

    <script>
      document.querySelector(".btn-dark.w-100").addEventListener("click", async function (event) {
        event.preventDefault();
        const payButton = this;
        const payment_method = document.querySelector("input[name='payment_method']:checked").value;
    
        payButton.disabled = true;
        payButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
    
        try {
          const totalamount = <%= total %>;
          const totals = totalamount + (totalamount > 499 ? 0 : 69);
          console.log(`Total amount: ${totals}`);
    
          // ---------------- COD ----------------
          if (payment_method === "cod") {
            console.log("Placing COD order...");
    
            const orderResponse = await fetch('/order/addorder', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
              },
              body: JSON.stringify({
                user_id: "<%= user.id %>",
                cartItems: <%- JSON.stringify(cartItems) %>,
                total_amount: totals,
                payment_method: "cod"
              })
            });
    
            const orderResult = await orderResponse.json();
            if (!orderResponse.ok) {
              throw new Error(orderResult.error || 'Failed to create COD order');
            }
    
            console.log("COD Order created:", orderResult);
            window.location.href = `/order/${orderResult.order_id}`;
            return; // stop here, no Razorpay for COD
          }
    
          // ---------------- ONLINE (Razorpay) ----------------
          if (payment_method === "online") {
            // 1. Create Razorpay order
            const { data } = await axios.post("/payment/create-order", { amount: totals });
            const order = data.order;
    
            const options = {
              key: "<%= key_id %>",
              amount: order.amount,
              currency: "INR",
              order_id: order.id,
              name: "BL TRADING",
              description: "Checkout Payment",
              handler: async function (response) {
                try {
                  // 2. Verify payment
                  const verifyResponse = await axios.post("/payment/verify", response);
                  if (verifyResponse.data.status === "success") {
                    // 3. Save order in DB
                    const orderResponse = await fetch('/order/addorder', {
                      method: 'POST',
                      headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                      },
                      body: JSON.stringify({
                        user_id: "<%= user.id %>",
                        cartItems: <%- JSON.stringify(cartItems) %>,
                        total_amount: totals,
                        payment_method: "online"
                      })
                    });
    
                    const orderResult = await orderResponse.json();
                    if (!orderResponse.ok) {
                      throw new Error(orderResult.error || 'Failed to create order');
                    }
    
                    console.log("Online Order created:", orderResult);
                    window.location.href = `/order/${orderResult.order_id}`;
                  } else {
                    throw new Error('Payment verification failed');
                  }
                } catch (error) {
                  console.error("Error in payment handler:", error);
                  alert(error.message || "Payment failed. Try again.");
                  payButton.disabled = false;
                  payButton.textContent = 'Pay Now';
                }
              },
              modal: {
                ondismiss: function() {
                  payButton.disabled = false;
                  payButton.textContent = 'Pay Now';
                }
              }
            };
    
            const rzp = new Razorpay(options);
            rzp.open();
          }
    
        } catch (error) {
          console.error("Error in payment flow:", error);
          alert(error.message || "Something went wrong. Try again.");
          payButton.disabled = false;
          payButton.textContent = 'Pay Now';
        }
      });
    </script>
    

    </script>
        <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        
    

</body>
<script>
  // Auto-close navbar on link/button click in mobile view
  document.addEventListener('DOMContentLoaded', function () {
    const navbarContent = document.getElementById('navbarContent');
    if (!navbarContent) return;

    const toggler = document.querySelector('.navbar-toggler');
    // Use Bootstrap Collapse instance without auto toggle on init
    const collapse = new bootstrap.Collapse(navbarContent, { toggle: false });

    const selectors = ['#navbarContent .nav-link', '#navbarContent .btn'];
    const clickable = document.querySelectorAll(selectors.join(','));
    clickable.forEach(el => {
      el.addEventListener('click', () => {
        // Only hide if toggler is visible (i.e., on mobile)
        if (window.getComputedStyle(toggler).display !== 'none') {
          collapse.hide();
        }
      });
    });
  });
</script>
</html>